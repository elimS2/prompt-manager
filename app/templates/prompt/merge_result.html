{% extends "base.html" %}

{% block title %}Merge Result - Prompt Manager{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-10">
        <div class="card theme-surface theme-border">
            <div class="card-header bg-success text-white theme-border border-bottom">
                <h3 class="mb-0 theme-text"><i class="bi bi-check-circle"></i> Merge Successful</h3>
            </div>
            <div class="card-body theme-text">
                <!-- Merge Metadata -->
                <div class="alert alert-info theme-transition">
                    <div class="row">
                        <div class="col-md-4">
                            <strong class="theme-text">Strategy:</strong> {{ metadata.strategy|title }}
                        </div>
                        <div class="col-md-4">
                            <strong class="theme-text">Prompts Merged:</strong> {{ metadata.prompt_count }}
                        </div>
                        <div class="col-md-4">
                            <strong class="theme-text">Merged At:</strong> {{ metadata.merged_at[:10] }}
                        </div>
                    </div>
                    <div class="mt-2">
                        <strong class="theme-text">Source Prompts:</strong>
                        <ul class="mb-0 theme-text">
                            {% for title in metadata.prompt_titles %}
                                <li>{{ title }}</li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>
                
                <!-- Merged Content -->
                <div class="mb-4">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h5 class="theme-text">Merged Content</h5>
                        <div>
                            <span class="theme-text-secondary me-3">
                                <i class="bi bi-file-text"></i> {{ merged_content|length }} characters
                            </span>
                            <button class="btn btn-success theme-transition" onclick="copyMergedContent()">
                                <i class="bi bi-clipboard"></i> Copy to Clipboard
                            </button>
                        </div>
                    </div>
                    <div class="border rounded p-3 theme-surface theme-border" style="max-height: 500px; overflow-y: auto;">
                        <pre id="mergedContent" class="theme-text" style="white-space: pre-wrap; margin-bottom: 0;">{{ merged_content }}</pre>
                    </div>
                </div>
                
                <!-- Actions -->
                <div class="row">
                    <div class="col-md-12">
                        <h5 class="theme-text">What would you like to do next?</h5>
                        <div class="d-flex gap-2 flex-wrap">
                            <button class="btn btn-primary theme-transition" onclick="createPromptFromMerge()">
                                <i class="bi bi-plus-circle"></i> Save as New Prompt
                            </button>
                            <button class="btn btn-outline-primary theme-transition" onclick="editMergedContent()">
                                <i class="bi bi-pencil"></i> Edit Content
                            </button>
                            <button class="btn btn-success theme-transition" onclick="sendToCursor()" id="cursorBtn">
                                <i class="bi bi-cursor"></i> Send to Cursor IDE
                            </button>
                            <a href="{{ url_for('prompt.merge') }}" class="btn btn-outline-secondary theme-transition">
                                <i class="bi bi-arrows-collapse"></i> Merge More Prompts
                            </a>
                            <a href="{{ url_for('prompt.index') }}" class="btn btn-secondary theme-transition">
                                <i class="bi bi-house"></i> Back to Prompts
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Edit Modal -->
<div class="modal fade" id="editModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Merged Content</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <textarea class="form-control" id="editedContent" rows="15">{{ merged_content }}</textarea>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="applyEdits()">Apply Changes</button>
            </div>
        </div>
    </div>
</div>

<!-- Create Prompt Form (Hidden) -->
<form id="createPromptForm" method="POST" action="{{ url_for('prompt.create') }}" style="display: none;">
    <input type="hidden" name="title" id="promptTitle">
    <textarea name="content" id="promptContent"></textarea>
    <input type="hidden" name="description" value="Created from merged prompts">
    <input type="hidden" name="tags" value="merged">
</form>

<!-- Cursor Instructions Modal -->
<div class="modal fade" id="cursorModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-cursor"></i> Send to Cursor IDE
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="cursorStatus" class="mb-3">
                    <div class="d-flex align-items-center">
                        <div class="spinner-border spinner-border-sm me-2" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <span>Checking Cursor IDE availability...</span>
                    </div>
                </div>
                
                <div id="cursorInstructions" style="display: none;">
                    <div class="alert alert-info">
                        <h6><i class="bi bi-info-circle"></i> Instructions</h6>
                        <ol id="instructionList" class="mb-0">
                            <!-- Instructions will be populated here -->
                        </ol>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label"><strong>Choose Method:</strong></label>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="cursorMethod" 
                                   id="clipboardMethod" value="clipboard" checked>
                            <label class="form-check-label" for="clipboardMethod">
                                <strong>üìã Copy to Clipboard (Recommended)</strong>
                                <p class="text-muted small mb-0">Instantly copy the prompt to your clipboard, then paste it into Cursor's chat</p>
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="cursorMethod" 
                                   id="fileMethod" value="file">
                            <label class="form-check-label" for="fileMethod">
                                <strong>üìÅ Open as File</strong>
                                <p class="text-muted small mb-0">Open the prompt as a temporary file in Cursor IDE, then copy from there</p>
                            </label>
                        </div>
                    </div>
                    
                    <div class="d-flex gap-2">
                        <button type="button" class="btn btn-success" onclick="executeCursorAction()">
                            <i class="bi bi-cursor"></i> Send to Cursor
                        </button>
                        <button type="button" class="btn btn-outline-secondary" onclick="copyPromptContent()">
                            <i class="bi bi-clipboard"></i> Copy Content
                        </button>
                    </div>
                </div>
                
                <div id="cursorError" style="display: none;">
                    <div class="alert alert-warning">
                        <h6><i class="bi bi-exclamation-triangle"></i> Cursor IDE Not Found</h6>
                        <p class="mb-2">Cursor IDE was not detected on your system. You can still manually copy the prompt content.</p>
                        <button type="button" class="btn btn-outline-secondary" onclick="copyPromptContent()">
                            <i class="bi bi-clipboard"></i> Copy Content Manually
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    function copyMergedContent() {
        const content = document.getElementById('mergedContent').textContent;
        navigator.clipboard.writeText(content).then(function() {
            // Change button temporarily
            const btn = event.target.closest('button');
            const originalHtml = btn.innerHTML;
            btn.innerHTML = '<i class="bi bi-check"></i> Copied!';
            btn.classList.remove('btn-success');
            btn.classList.add('btn-secondary');
            
            setTimeout(() => {
                btn.innerHTML = originalHtml;
                btn.classList.remove('btn-secondary');
                btn.classList.add('btn-success');
            }, 2000);
        }, function(err) {
            alert('Could not copy text: ' + err);
        });
    }
    
    function editMergedContent() {
        const modal = new bootstrap.Modal(document.getElementById('editModal'));
        modal.show();
    }
    
    function applyEdits() {
        const editedContent = document.getElementById('editedContent').value;
        document.getElementById('mergedContent').textContent = editedContent;
        bootstrap.Modal.getInstance(document.getElementById('editModal')).hide();
    }
    
    function createPromptFromMerge() {
        const title = prompt('Enter a title for the new prompt:', 'Merged Prompt - {{ metadata.merged_at[:10] }}');
        if (title) {
            const content = document.getElementById('mergedContent').textContent;
            document.getElementById('promptTitle').value = title;
            document.getElementById('promptContent').value = content;
            document.getElementById('createPromptForm').submit();
        }
    }
    
    // Cursor IDE Integration Functions
    function sendToCursor() {
        const modal = new bootstrap.Modal(document.getElementById('cursorModal'));
        modal.show();
        
        // Check Cursor status
        checkCursorStatus();
    }
    
    function checkCursorStatus() {
        fetch('/api/cursor/status')
            .then(response => response.json())
            .then(data => {
                document.getElementById('cursorStatus').style.display = 'none';
                
                if (data.available) {
                    document.getElementById('cursorInstructions').style.display = 'block';
                    // Set default instructions
                    setDefaultInstructions();
                } else {
                    document.getElementById('cursorError').style.display = 'block';
                }
            })
            .catch(error => {
                console.error('Error checking Cursor status:', error);
                document.getElementById('cursorStatus').style.display = 'none';
                document.getElementById('cursorError').style.display = 'block';
            });
    }
    
    function setDefaultInstructions() {
        const instructionList = document.getElementById('instructionList');
        instructionList.innerHTML = `
            <li><strong>Open Cursor IDE</strong> - Launch or switch to Cursor</li>
            <li><strong>Navigate to Chat</strong> - Open or switch to the active chat panel</li>
            <li><strong>Paste Content</strong> - Use Ctrl+V (Windows) or Cmd+V (Mac)</li>
            <li><strong>Send Prompt</strong> - Press Enter to send to AI assistant</li>
        `;
    }
    
    function executeCursorAction() {
        const method = document.querySelector('input[name="cursorMethod"]:checked').value;
        const content = document.getElementById('mergedContent').textContent;
        const title = 'Merged Prompt - {{ metadata.merged_at[:10] }}';
        
        const button = event.target;
        const originalText = button.innerHTML;
        button.innerHTML = '<i class="spinner-border spinner-border-sm"></i> Sending...';
        button.disabled = true;
        
        // Clear any existing alerts
        const existingAlerts = document.querySelectorAll('.alert');
        existingAlerts.forEach(alert => alert.remove());
        
        fetch('/api/cursor/send', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                content: content,
                title: title,
                method: method
            })
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            button.innerHTML = originalText;
            button.disabled = false;
            
            if (data.success) {
                // Update instructions if provided
                if (data.instructions) {
                    const instructionList = document.getElementById('instructionList');
                    instructionList.innerHTML = data.instructions.map(instruction => 
                        `<li>${instruction}</li>`
                    ).join('');
                }
                
                // Show success message
                showAlert('success', data.message);
                
                // If file method was used, show additional info
                if (method === 'file' && data.file_path) {
                    showAlert('info', `File opened: ${data.file_path}`);
                }
            } else {
                showAlert('warning', data.message || 'Failed to send to Cursor IDE');
            }
        })
        .catch(error => {
            console.error('Error sending to Cursor:', error);
            button.innerHTML = originalText;
            button.disabled = false;
            
            let errorMessage = 'Error sending to Cursor IDE. Please try again.';
            if (error.message.includes('HTTP')) {
                errorMessage = `Server error: ${error.message}`;
            } else if (error.message.includes('fetch')) {
                errorMessage = 'Network error. Please check your connection.';
            }
            
            showAlert('danger', errorMessage);
        });
    }
    
    function copyPromptContent() {
        const content = document.getElementById('mergedContent').textContent;
        const title = 'Merged Prompt - {{ metadata.merged_at[:10] }}';
        const formattedContent = `# ${title}\n\n${content}`;
        
        navigator.clipboard.writeText(formattedContent).then(function() {
            showAlert('success', 'Prompt content copied to clipboard!');
        }, function(err) {
            showAlert('warning', 'Could not copy to clipboard automatically. Please copy manually.');
        });
    }
    
    function showAlert(type, message) {
        // Create alert element
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
        alertDiv.innerHTML = `
            <i class="bi bi-${type === 'success' ? 'check-circle' : type === 'warning' ? 'exclamation-triangle' : type === 'danger' ? 'x-circle' : 'info-circle'}"></i>
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        // Insert at the top of the card body
        const cardBody = document.querySelector('.card-body');
        cardBody.insertBefore(alertDiv, cardBody.firstChild);
        
        // Scroll to alert
        alertDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
        
        // Auto-dismiss after 8 seconds for success, 10 seconds for others
        const dismissTime = type === 'success' ? 8000 : 10000;
        setTimeout(() => {
            if (alertDiv.parentNode) {
                alertDiv.remove();
            }
        }, dismissTime);
    }
</script>
{% endblock %}
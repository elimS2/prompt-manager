{% extends "base.html" %}

{% block title %}Edit Prompt - Prompt Manager{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h3 class="mb-0">Edit Prompt</h3>
            </div>
            <div class="card-body">
                <form method="POST" action="{{ url_for('prompt.edit', id=prompt.id) }}" id="editForm">
                    <!-- Title Field -->
                    <div class="mb-3">
                        <label for="title" class="form-label">Title <span class="text-danger">*</span></label>
                        <input type="text" 
                               class="form-control" 
                               id="title" 
                               name="title" 
                               value="{{ prompt.title }}"
                               required 
                               maxlength="255"
                               placeholder="Enter a descriptive title for your prompt">
                        <div class="form-text">Maximum 255 characters</div>
                    </div>
                    
                    <!-- Content Field -->
                    <div class="mb-3">
                        <label for="content" class="form-label">Content <span class="text-danger">*</span></label>
                        <textarea class="form-control" 
                                  id="content" 
                                  name="content" 
                                  rows="8" 
                                  required
                                  placeholder="Enter your prompt content here...">{{ prompt.content }}</textarea>
                        <div class="form-text">
                            <span id="charCount">{{ prompt.content|length }}</span> characters
                        </div>
                    </div>
                    
                    <!-- Description Field -->
                    <div class="mb-3">
                        <label for="description" class="form-label">Description</label>
                        <textarea class="form-control" 
                                  id="description" 
                                  name="description" 
                                  rows="3"
                                  placeholder="Optional: Add a brief description of what this prompt does">{{ prompt.description or '' }}</textarea>
                    </div>
                    
                    <!-- Tags Field -->
                    <div class="mb-4">
                        <label for="tags" class="form-label">Tags</label>
                        <input type="text" 
                               class="form-control" 
                               id="tags" 
                               name="tags"
                               value="{{ tag_names }}"
                               placeholder="Enter tags separated by commas (e.g., python, code-review, documentation)">
                        <div class="form-text">Tags help organize and find prompts later</div>
                    </div>
                    
                    <!-- Active Status -->
                    <div class="form-check mb-4">
                        <input class="form-check-input" 
                               type="checkbox" 
                               id="is_active" 
                               name="is_active" 
                               value="true"
                               {% if prompt.is_active %}checked{% endif %}>
                        <label class="form-check-label" for="is_active">
                            Active (visible in lists and searches)
                        </label>
                    </div>
                    
                    <!-- Version History Note -->
                    <div class="alert alert-info" role="alert">
                        <i class="bi bi-info-circle"></i> 
                        <strong>Note:</strong> This prompt was created {{ prompt.created_at.strftime('%B %d, %Y') }} 
                        and last updated {{ prompt.updated_at.strftime('%B %d, %Y at %I:%M %p') }}.
                    </div>
                    
                    <!-- Action Buttons -->
                    <div class="d-flex justify-content-between">
                        <a href="{{ url_for('prompt.view', id=prompt.id) }}" class="btn btn-secondary">
                            <i class="bi bi-arrow-left"></i> Cancel
                        </a>
                        <div>
                            <button type="button" class="btn btn-outline-primary" id="previewBtn">
                                <i class="bi bi-eye"></i> Preview Changes
                            </button>
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-save"></i> Save Changes
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Preview Modal -->
<div class="modal fade" id="previewModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Preview Changes</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>Current Version</h6>
                        <div class="border rounded p-3 bg-light">
                            <h5>{{ prompt.title }}</h5>
                            <p class="text-muted small">{{ prompt.description or 'No description' }}</p>
                            <pre class="small">{{ prompt.content[:200] }}...</pre>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h6>Updated Version</h6>
                        <div class="border rounded p-3">
                            <h5 id="previewTitle"></h5>
                            <p class="text-muted small" id="previewDescription"></p>
                            <pre class="small" id="previewContent"></pre>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Character counter
    const contentField = document.getElementById('content');
    const charCount = document.getElementById('charCount');
    
    contentField.addEventListener('input', function() {
        charCount.textContent = this.value.length;
    });
    
    // Preview functionality
    const previewBtn = document.getElementById('previewBtn');
    const previewModal = new bootstrap.Modal(document.getElementById('previewModal'));
    
    previewBtn.addEventListener('click', function() {
        const title = document.getElementById('title').value;
        const content = document.getElementById('content').value;
        const description = document.getElementById('description').value;
        
        document.getElementById('previewTitle').textContent = title || 'No title';
        const contentPreview = content.length > 200 ? content.substring(0, 200) + '...' : content;
        document.getElementById('previewContent').textContent = contentPreview || 'No content';
        document.getElementById('previewDescription').textContent = description || 'No description';
        
        previewModal.show();
    });
    
    // Form validation
    const form = document.getElementById('editForm');
    form.addEventListener('submit', function(e) {
        const title = document.getElementById('title').value.trim();
        const content = document.getElementById('content').value.trim();
        
        if (!title || !content) {
            e.preventDefault();
            alert('Title and content are required');
            return;
        }
        
        // Validate title length
        if (title.length > 255) {
            e.preventDefault();
            alert('Title must be less than 255 characters');
            return;
        }
        
        // Validate tags
        const tagsInput = document.getElementById('tags');
        const tagString = tagsInput.value.trim();
        if (tagString) {
            const tags = tagString.split(',').map(tag => tag.trim()).filter(tag => tag);
            for (const tag of tags) {
                if (tag.length > 50) {
                    e.preventDefault();
                    alert(`Tag "${tag}" is too long. Maximum 50 characters allowed.`);
                    return;
                }
                if (!/^[a-zA-Z0-9\s-]+$/.test(tag)) {
                    e.preventDefault();
                    alert(`Tag "${tag}" contains invalid characters. Only letters, numbers, spaces, and hyphens are allowed.`);
                    return;
                }
            }
        }
    });
    
    // Warn about unsaved changes
    let formChanged = false;
    const formInputs = form.querySelectorAll('input, textarea');
    
    formInputs.forEach(input => {
        input.addEventListener('change', () => {
            formChanged = true;
        });
    });
    
    window.addEventListener('beforeunload', (e) => {
        if (formChanged) {
            e.preventDefault();
            e.returnValue = '';
        }
    });
    
    form.addEventListener('submit', () => {
        formChanged = false;
    });
    
    // Tag input enhancement
    const tagsInput = document.getElementById('tags');
    tagsInput.addEventListener('input', function() {
        // Auto-format tags: remove extra spaces and normalize
        let value = this.value;
        
        // Remove multiple spaces
        value = value.replace(/\s+/g, ' ');
        
        // Remove spaces around commas
        value = value.replace(/\s*,\s*/g, ', ');
        
        // Remove leading/trailing spaces
        value = value.trim();
        
        this.value = value;
    });
    
    // Enhanced tag input handling
    tagsInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            
            // Add comma if not at the end
            const cursorPos = this.selectionStart;
            const value = this.value;
            
            if (cursorPos < value.length && value[cursorPos] !== ',') {
                const before = value.substring(0, cursorPos);
                const after = value.substring(cursorPos);
                this.value = before + ', ' + after;
                this.setSelectionRange(cursorPos + 2, cursorPos + 2);
            }
        }
    });
</script>
{% endblock %}